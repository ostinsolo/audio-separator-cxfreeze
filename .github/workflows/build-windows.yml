name: build-windows
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-windows-cpu:
    name: Build for Windows (CPU)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install 'numpy<2' 'cx-Freeze==6.15.16' audio-separator onnxruntime samplerate
      - run: pip install torch==2.2.2 --index-url https://download.pytorch.org/whl/cpu
      - run: cxfreeze main.py --target-dir=audio-separator-win-cpu --target-name=audio-separator --packages=audio_separator,onnxruntime,samplerate
      - run: |
          .\audio-separator-win-cpu\audio-separator.exe --help
      - run: Compress-Archive -Path audio-separator-win-cpu -DestinationPath audio-separator-win-cpu.zip
      - uses: actions/upload-artifact@v4
        with:
          name: audio-separator-win-cpu
          path: audio-separator-win-cpu.zip

  build-windows-cuda:
    name: Build for Windows (CUDA 12.1)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: pip install 'numpy<2' 'cx-Freeze==6.15.16' audio-separator onnxruntime-gpu samplerate
      # Install PyTorch with CUDA 12.1 support
      - run: pip install torch==2.2.2+cu121 --index-url https://download.pytorch.org/whl/cu121
      - run: cxfreeze main.py --target-dir=audio-separator-win-cuda --target-name=audio-separator --packages=audio_separator,onnxruntime,samplerate
      - run: |
          .\audio-separator-win-cuda\audio-separator.exe --help
      - run: Compress-Archive -Path audio-separator-win-cuda -DestinationPath audio-separator-win-cuda.zip
      - uses: actions/upload-artifact@v4
        with:
          name: audio-separator-win-cuda
          path: audio-separator-win-cuda.zip

  release:
    name: Create Windows Release
    needs: [build-windows-cpu, build-windows-cuda]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: audio-separator-win-cpu
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: audio-separator-win-cuda
          path: ./artifacts
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.1.0-win
          name: v1.1.0 - Audio Separator Windows (CPU + CUDA)
          body: |
            ## Audio Separator v1.1.0 - Windows
            
            ### Variants
            - **audio-separator-win-cpu.zip**: CPU only (works everywhere)
            - **audio-separator-win-cuda.zip**: CUDA 12.1 (NVIDIA GPU acceleration)
            
            ### CUDA Requirements
            - NVIDIA GPU with CUDA 12.1 support
            - Latest NVIDIA drivers installed
            
            ### Usage
            ```powershell
            .\audio-separator.exe -m "17_HP-Wind_Inst-UVR.pth" --output_dir output input.wav
            ```
          files: |
            ./artifacts/audio-separator-win-cpu.zip
            ./artifacts/audio-separator-win-cuda.zip
          draft: false
          prerelease: false
