name: build-mac
on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build-mac-intel:
    name: Build for macOS Intel (CPU)
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      # Install all dependencies including Apollo's
      - run: |
          pip install 'numpy<2' 'cx-Freeze==6.15.16' 'torch==2.2.2' 'torchaudio==2.2.2'
          pip install audio-separator onnxruntime samplerate
          pip install soundfile omegaconf pytorch-lightning huggingface_hub scipy
      - run: |
          cxfreeze main.py --target-dir=audio-separator-mac-intel --target-name=audio-separator \
            --packages=audio_separator,onnxruntime,samplerate,apollo,apollo.look2hear,apollo.look2hear.models,soundfile,omegaconf,scipy
      - run: |
          chmod +x audio-separator-mac-intel/audio-separator
          ./audio-separator-mac-intel/audio-separator --help
      - run: ditto -c -k --sequesterRsrc --keepParent audio-separator-mac-intel audio-separator-mac-intel.zip
      - uses: actions/upload-artifact@v4
        with:
          name: audio-separator-mac-intel
          path: audio-separator-mac-intel.zip

  build-mac-arm:
    name: Build for macOS ARM (MPS GPU)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      # Install all dependencies including Apollo's
      - run: |
          pip install 'numpy<2' 'cx-Freeze==6.15.16' 'torch==2.2.2' 'torchaudio==2.2.2'
          pip install audio-separator onnxruntime samplerate
          pip install soundfile omegaconf pytorch-lightning huggingface_hub scipy
      - run: |
          cxfreeze main.py --target-dir=audio-separator-mac-arm --target-name=audio-separator \
            --packages=audio_separator,onnxruntime,samplerate,apollo,apollo.look2hear,apollo.look2hear.models,soundfile,omegaconf,scipy
      - run: |
          chmod +x audio-separator-mac-arm/audio-separator
          ./audio-separator-mac-arm/audio-separator --help
      - run: ditto -c -k --sequesterRsrc --keepParent audio-separator-mac-arm audio-separator-mac-arm.zip
      - uses: actions/upload-artifact@v4
        with:
          name: audio-separator-mac-arm
          path: audio-separator-mac-arm.zip

  release:
    name: Create Release
    needs: [build-mac-intel, build-mac-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: audio-separator-mac-intel
          path: ./artifacts
      - uses: actions/download-artifact@v4
        with:
          name: audio-separator-mac-arm
          path: ./artifacts
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.2.0
          name: v1.2.0 - Audio Separator + Apollo
          body: |
            ## Audio Separator v1.2.0 + Apollo Audio Restoration
            
            Standalone frozen binary for audio source separation AND restoration.
            
            ### NEW: Apollo Audio Restoration
            Convert lossy compressed audio (MP3, AAC) to higher quality!
            
            ```bash
            # Apollo mode
            ./audio-separator --apollo input.mp3 -o restored.wav -m apollo_lew_uni.ckpt
            ```
            
            **Apollo Models:**
            - `apollo_lew_uni.ckpt` - RECOMMENDED (feature_dim=384)
            - `apollo_official.bin` - General restoration (feature_dim=256)
            - `apollo_lew_v2.ckpt` - Lightweight (feature_dim=192)
            - `apollo_edm_big.ckpt` - EDM/Electronic (feature_dim=256)
            
            ### Audio Separation (unchanged)
            ```bash
            ./audio-separator -m "17_HP-Wind_Inst-UVR.pth" --output_dir output input.wav
            ```
            
            ### GPU Support
            - **macOS ARM**: MPS (Metal) acceleration for separation
            - **macOS Intel**: CPU only
            - **Windows**: See Windows release for CUDA support
            
            ### Supported Separation Models
            - VR Architecture (wind instruments, vocals, etc.)
            - MDX Architecture
            - Demucs
            - Roformer
          files: |
            ./artifacts/audio-separator-mac-intel.zip
            ./artifacts/audio-separator-mac-arm.zip
          draft: false
          prerelease: false
