name: build-mac
on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build-mac-arm:
    name: Build for macOS (ARM - Apple Silicon)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # Install all dependencies (matching build-intel.sh)
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install 'cx-Freeze==6.15.16'
          
          # PyTorch for macOS ARM
          pip install 'numpy<2' 'torch==2.2.2' 'torchaudio==2.2.2'
          
          # Audio separator (no-deps to control versions)
          pip install --no-deps audio-separator
          
          # All dependencies from python-audio-separator + our testing
          pip install \
            requests \
            librosa \
            samplerate \
            six \
            tqdm \
            pydub \
            onnx \
            onnx2torch \
            onnxruntime \
            julius \
            diffq \
            einops \
            pyyaml \
            ml_collections \
            resampy \
            beartype \
            rotary-embedding-torch \
            scipy \
            soundfile
          
          # Additional for cx_Freeze bundling
          pip install torchvision pytorch-lightning huggingface_hub omegaconf
      
      # Build with all packages
      - name: Build frozen binary
        run: |
          cxfreeze main.py \
            --target-dir=audio-separator-mac \
            --target-name=audio-separator \
            --packages=audio_separator,onnxruntime,samplerate,apollo,apollo.look2hear,apollo.look2hear.models,soundfile,omegaconf,scipy,requests,librosa,pydub,einops,julius,diffq,resampy \
            --include-files=apollo
      
      - name: Test binary
        run: |
          chmod +x audio-separator-mac/audio-separator
          ./audio-separator-mac/audio-separator --version
          ./audio-separator-mac/audio-separator --help | head -10
      
      - name: Create zip
        run: ditto -c -k --sequesterRsrc --keepParent audio-separator-mac audio-separator-mac-arm.zip
      
      - uses: actions/upload-artifact@v4
        with:
          name: audio-separator-mac-arm
          path: audio-separator-mac-arm.zip

  release:
    name: Create Release
    needs: [build-mac-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: audio-separator-mac-arm
          path: ./artifacts
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.2.2
          name: v1.2.2 - Audio Separator + Apollo ARM Fix
          body: |
            ## Audio Separator v1.2.2 + Apollo Audio Restoration
            
            **ARM Mac Fix:** Fixed PyTorch 2.x + cx_Freeze compatibility issue that caused
            `OSError: could not get source code` on Apple Silicon Macs.
            
            ### What's Fixed
            - Added monkey-patch for `inspect.getsourcelines` to handle frozen executables
            - ARM builds now work correctly with PyTorch 2.2.2
            
            ### Features
            
            #### Apollo Audio Restoration
            Convert lossy compressed audio (MP3, AAC) to higher quality:
            ```bash
            ./audio-separator --apollo input.mp3 -o restored.wav -m apollo_lew_uni.ckpt
            ```
            
            #### Audio Separation
            ```bash
            ./audio-separator -m "17_HP-Wind_Inst-UVR.pth" --output_dir output input.wav
            ```
            
            ### GPU Support
            | Platform | Separation | Apollo |
            |----------|------------|--------|
            | macOS ARM (M1/M2/M3) | MPS (Metal) | CPU |
            | macOS Intel | CPU | CPU |
            | Windows | CPU | CPU |
            
            ### Downloads
            - **macOS ARM (Apple Silicon)**: `audio-separator-mac-arm.zip`
            - **macOS Intel**: See v1.2.1 Intel build
            - **Windows**: See Windows release
          files: |
            ./artifacts/audio-separator-mac-arm.zip
          draft: false
          prerelease: false
